# v3.7.0 Release Post-Mortem (Library Fetcher Speed Optimization)

**Date**: 2025-12-11
**Duration**: ~1 day
**Versions Iterated**: 4 letter versions (v3.5.0.a through v3.5.0.d)
**Release Components**:
- amazon-library-fetcher.js v3.5.0
- Project version v3.7.0

---

## üéØ What Worked Well

### 1. **Diagnostic Script Approach**
- diag-03-batch-enrichment.js systematically tested batch sizes
- Discovered Amazon's 30-ASIN limit (31+ fails with "Cannot return null for non-nullable type")
- GraphQL syntax requirement found: unquoted keys `{asin: "X"}` not JSON `{"asin": "X"}`
- **Lesson**: When exploring API limits, use diagnostic scripts to test systematically

### 2. **Incremental Letter Versions**
- v3.5.0.a ‚Üí .b ‚Üí .c ‚Üí .d tracked each iteration
- Easy to identify which version was running in console
- Enabled rollback if needed
- **Lesson**: Letter versions as checkpoints work well for iterative development

### 3. **Partial Error Handling Pattern**
- Amazon returns data + errors simultaneously (GraphQL partial errors)
- Code gracefully extracts data even when errors present
- 504.1 timeouts don't lose data - they just return partial results
- **Lesson**: Don't fail on errors if you still got useful data

### 4. **User-Driven Bug Pattern Search**
- User noticed negative time (-55s) in Pass 3
- Found `mergeEnd` was never set
- User prompted: "check for similar issues in both fetchers"
- Found `manifestStart`/`manifestEnd` also never set
- **Lesson**: When you find a bug, proactively search for the same pattern elsewhere

---

## ‚ùå Mistakes Made

### 1. **Version Increment Timing**
- Made functional fix before incrementing version letter
- Should have: increment ‚Üí commit checkpoint ‚Üí make fix ‚Üí commit fix
- User caught this and corrected the workflow
- **Fix**: Added checkpoint commit step to INCREMENT-VERSION-ACTION

### 2. **Untested Commits**
- v3.5.0.c was committed but never tested
- Rolled additional changes (.d) into untested code
- Risk: could have compounded bugs
- **Fix**: Documented in commit message that .c wasn't tested

### 3. **Project vs File Version Confusion**
- Initially tried to release fetcher v3.5.0 as project v3.5.0
- Project was already at v3.6.1
- Correct: fetcher v3.5.0 releases as project v3.7.0 (minor bump for new functionality)
- **Fix**: User corrected; versions are independent per EXPLAIN-VERSION-INDEPENDENCE-ACTION

### 4. **Debug Log Accidentally Tracked**
- SKILL-Development-Ground-Rules-Log.md was in .gitignore but already committed
- .gitignore only prevents NEW files, not already-tracked ones
- **Fix**: `git rm --cached` to remove from tracking while keeping local file

---

## üìö Lessons Learned

### 1. **Batch Size Discovery**
Amazon's getProducts GraphQL endpoint:
- **Maximum**: 30 ASINs per call
- **31+**: Fails with "Cannot return null for non-nullable type"
- **GraphQL syntax**: Must use unquoted keys `{asin: "X"}` not `{"asin": "X"}`

### 2. **Amazon API Errors Are Often Benign**
- 504.1 timeout: Amazon backend service timeout - data still retrieved
- "Customer Id or Marketplace Id is invalid": Internal error - data still retrieved
- These look scary but don't indicate data loss

### 3. **When Finding Bugs, Search for Patterns**
- Bug found: `mergeEnd` never set ‚Üí negative timing
- Pattern search revealed: `manifestStart`/`manifestEnd` also never set
- **Key insight**: This requires user prompting - Claude doesn't naturally do this
- **Limitation**: Claude's "amnesia" means this lesson won't persist to future sessions

### 4. **Project and File Versions Are Independent**
- File version (FETCHER_VERSION): Developer-facing, tracks individual file changes
- Project version (README.md): User-facing, tracks releases that change user experience
- A fetcher v3.5.0 can release as project v3.7.0 - they're different versioning systems

---

## ü§ñ AI Collaboration Insights

### Claude as "Junior Engineer with Amnesia"
User's framing for working with Claude:
- **Strengths**: Fast, broad pattern recognition from training, follows protocols precisely
- **Weaknesses**: Lacks experiential wisdom, doesn't retain lessons across sessions
- **Ground rules**: Serve as externalized experience - bridge the gap
- **Limitation**: Can't encode ALL wisdom in rules without making them unwieldy

### Practices That Require User Prompting
Some best practices require the user to remember and prompt Claude:
1. "Check for similar patterns when you find a bug"
2. "Don't just fix the one instance - audit related code"
3. "What did we do before that worked?"

These are too situational for trigger-based rules but too important to forget.

---

## üîÑ Rule Updates Made

### INCREMENT-VERSION-ACTION Enhanced
Added step 4: **COMMIT the version increment as a checkpoint** before making functional changes
- Ensures version in console output matches committed code
- Enables rollback to any letter version if needed
- Squash letter commits when releasing

---

## üìä Release Statistics

### Performance Improvement
- **Before**: ~2 hours for 2000+ books (1 ASIN per call, delays between calls)
- **After**: ~1 minute for 2000+ books (30 ASINs per call, 0ms delays)
- **Improvement**: ~120x faster

### Code Changes
- **Files Changed**: amazon-library-fetcher.js
- **Key Changes**:
  - Batch enrichment (30 ASINs per call)
  - 0ms delays (network RTT provides natural throttling)
  - Error categorization in stats
  - Friendly error messages
  - Fixed timing stats

### Testing
- v3.5.0.d tested successfully
- No 504.1 errors encountered during test (will verify when Amazon servers next timeout)

---

## üìã Files Changed

**Fetcher**:
- amazon-library-fetcher.js v3.5.0 - Batch enrichment, error categorization

**Documentation**:
- CHANGELOG.md - v3.7.0 entry with Technical Notes
- README.md - Project version v3.7.0

**Housekeeping**:
- Removed SKILL-Development-Ground-Rules-Log.md from git tracking

---

## üí° Recommendations for Future

### 1. **Post-Mortem Folder Reference in Rules**
- Add reference to post-mortems/ folder in POST-RELEASE-TRIGGER actions
- Point to sample-post-mortem.md template
- Keeps format consistent across releases

### 2. **Pattern Search as Explicit Practice**
- Can't be a trigger (too situational)
- Document as "user should prompt" practice
- User's experienced judgment remains essential

### 3. **Version Checkpoint Workflow**
- Already added to INCREMENT-VERSION-ACTION
- Prevents version mismatch between console and commits

---

## üìñ Related Documentation

- **CHANGELOG.md**: [v3.7.0 entry](../CHANGELOG.md#370---2025-12-11)
- **Technical Notes**: Batch size 30 limit, GraphQL syntax, 504.1 errors

---

## Final Thoughts

This release demonstrates the value of systematic API exploration (diagnostic scripts) and the importance of user oversight when working with AI assistants. The 120x performance improvement came from understanding Amazon's undocumented batch limit.

The "junior engineer with amnesia" framing is useful - Claude can move fast and follow protocols, but lacks the experiential wisdom that comes from years of making mistakes. Ground rules help, but some lessons require real-time supervision from experienced humans.

**Key Takeaway**: When you find a bug pattern, prompt Claude to search for similar patterns elsewhere. It won't happen automatically, but it's a high-value practice.
