# v4.7.0 Release Post-Mortem (Sort by Published)

**Date**: 2026-01-04
**Duration**: ~1 day (single session)
**Versions Iterated**: 11 letter versions (v4.2.0.a through v4.2.0.k for fetcher)
**Release Components**:
- amazon-library-fetcher.js v4.3.0
- readerwrangler.js v4.7.0

---

## üéØ What Worked Well

### 1. **API Documentation Reference**
- Checked `docs/api/Amazon-API-Reference.md` before implementing publication date extraction
- Found `overview.sectionGroups` field structure documented, but needed to add publication date specifics
- **Lesson**: Maintain API documentation as a living reference; update it during feature development

### 2. **Iterative Bug Discovery During Testing**
- Testing revealed Pass 3 timing bug (mergeEnd never set on successful save)
- Testing revealed Cancel button incorrectly showing "FILE SAVED" message
- Testing revealed timing summary should print before save dialog (dev workflow insight)
- **Lesson**: Real testing catches bugs that code review misses

### 3. **UX Expert Hat Technique**
- User prompted for UX review of Cancel button implementation
- Caught semantic issue: underlined text is for links, not action buttons
- Changed from styled `<div>` to proper `<button>` with tooltip
- **Lesson**: Switching to "expert hat" mode forces critical evaluation of choices

---

## ‚ùå Mistakes Made

### 1. **Initial Implementation Missing timing.mergeEnd**
- Pass 3 timing showed negative/incorrect values because `stats.timing.mergeEnd` was only set in the "no new books" early-return path
- Should have traced through all code paths when adding timing instrumentation
- **Fix**: Added `stats.timing.mergeEnd = Date.now()` after successful save

### 2. **Cancel Button Didn't Prevent "FILE SAVED" Message**
- Initially, clicking Cancel still showed "FILE SAVED" because early return wasn't in all paths
- X button on file picker also didn't properly handle abort
- **Fix**: Restructured to check `userChoice === 'cancel'` before any save attempt

---

## üìö Lessons Learned

### 1. **User Gesture Expiration in Browser APIs**
- `showSaveFilePicker()` requires an "active user gesture" (click/keypress within ~seconds)
- After 3+ minute fetch operations, the original paste gesture has expired
- Solution: Show a "Save Library File" button that provides a fresh gesture
- Chrome error: "SecurityError: Must be handling a user gesture to show a file picker"
- **Critical for any long-running operation that needs File System Access API**

### 2. **GraphQL displayContent is a Leaf Type**
- `displayContent` in Amazon's API is an `Object!` GraphQL scalar (leaf type)
- Cannot request subselections like `.fragments[0].text` in the query
- Must parse the raw object client-side with fallback patterns
- Multiple possible structures: direct string, `{text: "..."}`, `{fragments: [...]}`, nested

---

## ü§ñ AI Collaboration Insights

### Practices That Required User Prompting
- UX review of button vs link semantics (user prompted for "UX expert hat")
- Moving timing summary before save dialog (user insight about dev workflow)
- Concise Recent Features text (user suggested "just Sort by Published")

### What Ground Rules Helped
- "Stop and ask" rule prevented releasing with timing bug unfixed
- Discussion trigger allowed UX conversation without immediate action
- Explicit approval workflow caught Cancel button issues before release

---

## üîÑ Rule Updates Made/Proposed

None - existing rules are sufficient when followed correctly.

---

## üìä Release Statistics

### Code Changes
- **Files Changed**: 11
- **Key Changes**:
  - Publication date extraction from Amazon GraphQL API
  - Sort by Published dropdown option
  - Save/Cancel button UX for fetcher
  - Timing summary moved before save dialog

### Testing
- Full fetch tested on live Amazon library
- Sort options tested on organizer
- Save/Cancel flow tested with both save and cancel paths
- Backwards compatibility confirmed (old data shows warning when sorting by publication date)

---

## üìã Files Changed

**Fetcher**:
- amazon-library-fetcher.js v4.3.0 - Publication date extraction, Save/Cancel UX, timing fixes

**Organizer**:
- readerwrangler.js v4.7.0 - Sort by Published, publication date in details modal

**Documentation**:
- CHANGELOG.md - v4.7.0 entry
- README.md - Version badge, Recent Features
- TODO.md - Removed completed Publication Date Feature
- index.html - Recent Features section
- docs/api/Amazon-API-Reference.md - Added overview field documentation
- docs/design/VIDEO-PRODUCTION-PLAN.md - Content Update Tracker

---

## üí° Recommendations for Future

### 1. **Test All Code Paths for Timing/Metrics**
- When adding instrumentation, trace through every exit path
- Consider using try/finally patterns to ensure metrics are always captured

### 2. **Document Browser API Gotchas**
- User gesture expiration is non-obvious
- Add to a "Browser API Gotchas" reference doc

---

## üìñ Related Documentation

- **CHANGELOG.md**: [v4.7.0 entry](../CHANGELOG.md#470---2026-01-04)
- **Amazon-API-Reference.md**: Updated with publication date extraction details

---

## Final Thoughts

Clean feature implementation with valuable lessons about browser APIs. The user gesture expiration issue was the most significant technical learning - it's a subtle constraint that can break seemingly simple file operations after long async workflows.

**Key Takeaway**: Browser APIs have timing constraints (user gestures expire) that require UX solutions (explicit save buttons) for long-running operations.
