# v4.8.0 Release Post-Mortem (Undo/Redo Support)

**Date**: 2026-01-06
**Duration**: ~2 days (2026-01-05 through 2026-01-06)
**Versions Iterated**: 11 letter versions (v4.8.0.a through v4.8.0.k)
**Release Components**:
- readerwrangler.js v4.8.0
- Project version v4.8.0

---

## ðŸŽ¯ What Worked Well

### 1. **Incremental Implementation Strategy**
- Implemented one action type at a time (MOVE_BOOKS â†’ REORDER_BOOKS â†’ TOGGLE_HIDE â†’ etc.)
- Each action fully tested before moving to next
- User confirmed "Works as expected" after each implementation
- **Lesson**: Complex features benefit from atomic, testable increments

### 2. **UX-Driven Scoping Decisions**
- Skipped CREATE_COLUMN (Delete Column exists for recovery)
- Skipped RENAME_COLUMN (easy manual fix, Windows Explorer doesn't support this either)
- Skipped CREATE_DIVIDER and RENAME_DIVIDER (same reasoning)
- **Lesson**: Not every reversible action needs undo - focus on destructive/hard-to-reverse actions

### 3. **Command Pattern Architecture**
- Each action stored with all data needed for reversal
- Clean separation between recording, undo execution, and redo execution
- 50-action stack limit with automatic cleanup
- **Lesson**: Command Pattern is ideal for undo/redo - explicit data capture beats implicit state tracking

---

## âŒ Mistakes Made

### 1. **Stale Closure Bug**
- Keyboard handler captured `undoStack` state variable at creation time
- Second Ctrl+Z operated on stale reference, re-undoing same action
- **Fix**: Added `undoStackRef` and `redoStackRef` with useEffect sync, read from refs in undo()/redo()

### 2. **Accidental File in Commit**
- `Untitled-1.groovy` (API capture from v4.7.0 investigation) got staged and committed
- Caught during release review
- **Fix**: `git rm --cached` and `--amend` to remove from commit

### 3. **Missed index.html Sync After Compaction**
- Ground rules (line 115) state: "index.html mirrors README.md but must manually be kept in sync"
- Updated README.md with v4.8.0 Recent Features but forgot to update index.html
- Root cause: After context compaction, relied on compaction summary's todo list rather than re-deriving requirements from ground rules
- User had to prompt for the fix after release was pushed
- **Fix**: When executing "Before Release" checklist, explicitly enumerate ALL items from ground rules, not just what's in memory/summary

---

## ðŸ“š Lessons Learned

### 1. **React Stale Closure in Event Handlers**
- useEffect keyboard handler captures state at registration time
- State variables become stale if not refreshed
- Pattern: Use refs that sync via useEffect for event handler access
```javascript
const undoStackRef = useRef(undoStack);
useEffect(() => { undoStackRef.current = undoStack; }, [undoStack]);
const undo = () => {
    const currentStack = undoStackRef.current; // Always current!
    ...
};
```

### 2. **Undo Data Capture Strategy**
- Capture state BEFORE the action executes
- Store everything needed to reverse: IDs, indices, objects, previous states
- Don't rely on being able to reconstruct - explicit is better than clever

---

## ðŸ¤– AI Collaboration Insights

### Practices That Required User Prompting
- UX decisions on what NOT to implement (CREATE_COLUMN, RENAME_COLUMN, etc.)
- Comparison to Windows File Explorer for rename undo expectations
- Show Hidden default change as UX improvement (noticed during testing)

### What Ground Rules Helped
- **Stop and ask**: Prevented racing ahead on implementation decisions
- **Code/Test Cycle**: Letter versioning enabled granular testing and rollback
- **Before Release**: Checklist caught the temp file before it went to production

---

## ðŸ”„ Rule Updates Made/Proposed

None - existing rules are sufficient when followed correctly.

---

## ðŸ“Š Release Statistics

### Code Changes
- **Files Changed**: 5
- **Lines Added**: ~1000
- **Key Changes**:
  - Undo/Redo state management (undoStack, redoStack, refs)
  - recordAction() function
  - executeUndo() and executeRedo() switch statements
  - 7 action types instrumented throughout codebase

### Testing
- All 7 action types tested by user
- Each confirmed "Works as expected" individually
- Multi-step undo/redo sequences verified

---

## ðŸ“‹ Files Changed

**Code**:
- readerwrangler.js v4.8.0 - Undo/redo infrastructure and all action instrumentation

**Documentation**:
- CHANGELOG.md - v4.8.0 entry
- README.md - Version badge, Recent Features
- index.html - Recent Features section (synced with README.md)
- TODO.md - Removed completed Undo/Redo item
- docs/design/UNDO-REDO-DESIGN.md - Design document (created during implementation)

---

## ðŸ’¡ Recommendations for Future

### 1. **Add Visual Feedback for Undo/Redo**
- Consider toast notification: "Undone: Move 3 books to [Column Name]"
- Would help users understand what was reversed
- Low priority since keyboard shortcuts are self-documenting

### 2. **Consider Undo for More Actions**
- If users request, could add: Multi-book delete, Clear column, etc.
- Current scope covers most common accidental actions

---

## ðŸ“– Related Documentation

- **CHANGELOG.md**: [v4.8.0 entry](../CHANGELOG.md#480---2026-01-06)
- **Design Doc**: [UNDO-REDO-DESIGN.md](../docs/design/UNDO-REDO-DESIGN.md)

---

## Final Thoughts

This was a well-executed feature implementation. The incremental approach (one action type at a time) prevented scope creep and made debugging straightforward. The stale closure bug was the only significant technical challenge, and the fix is now a documented pattern for future keyboard handlers.

The UX decisions to skip CREATE/RENAME operations was the right call - these are easily recoverable without undo, and implementing them would have added complexity without proportional benefit.

**Key Takeaway**: Command Pattern + incremental testing + UX-driven scoping = clean feature implementation.
