# Post-Mortem: v4.0.0 - Schema v2.0 Unified File Format

**Release Date:** 2025-12-25
**Commit:** 4d9b4d0
**Tag:** v4.0.0

---

## What Changed

### Breaking Changes
- **Schema v2.0 Unified File Format** - Single `amazon-library.json` replaces separate library + collections files
- File versions: readerwrangler.js v4.0.0, amazon-library-fetcher.js v4.0.0, amazon-collections-fetcher.js v2.0.0

### Unified File Structure
```json
{
  "schemaVersion": "2.0",
  "books": { "fetchDate": "...", "items": [...] },
  "collections": { "fetchDate": "...", "items": [...] },
  "organization": { "columns": [...], "columnOrder": [...] }
}
```

### Fetcher Improvements
- **File System Access API** - Chrome/Edge users get same-file overwrite (no more "(1).json" duplicates)
- **Fallback for Firefox/Safari** - Traditional download with clear user guidance
- **Backup file rejection** - Fetchers refuse to update backup files (prevents data loss)
- **Delta reporting** - "Added X new books (Y total)" instead of just total count

### App Improvements
- **Backup/Library distinction** - App detects `isBackup: true` and handles appropriately
- **Tooltips added** - Add Column, Import, Export buttons now have tooltips
- **Data Status modal fix** - Fixed crash when viewing collections without `id` field

---

## What Went Well

1. **Design doc paid off** - `SCHEMA-V2-UNIFIED-FILE.md` provided clear specifications for fetcher ownership model
2. **Iterative testing** - Multiple test runs on dev environment caught issues early
3. **File System Access API** - Significant UX improvement for Chrome/Edge users (95%+ of users)

---

## What Went Wrong

1. **Version commits lost** - One session wasn't committing at each letter increment, requiring reconstruction from conversation logs
2. **Context compaction** - Multiple compactions during implementation made continuity harder
3. **Conversation file analysis** - Had to deduce changes from 7154-line conversation dump instead of git history

---

## Lessons Learned

1. **Commit discipline** - Even during rapid iteration, each version letter MUST get a commit
2. **Conversation exports** - Saving conversation logs enabled recovery of missing commit history
3. **Ground Rules work** - The commit-before-test workflow, when followed, prevents this issue

---

## Migration Impact

- **Existing users**: Must re-run fetchers to generate v2.0 format files
- **Backward compatibility**: App accepts both v1.x and v2.0 files on import
- **File cleanup**: `amazon-collections.json` is now obsolete (users can delete)

---

## Next Steps

- Wishlist Integration (T1 on TODO.md) - next major feature
